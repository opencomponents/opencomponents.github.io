"use strict";(self.webpackChunkoc_website=self.webpackChunkoc_website||[]).push([[3508],{4852:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"registry/registry-using-google-storage","title":"Registry using Google Storage","description":"To use Google Storage make sure you have an account and credentials. When running on a server don\'t forget to set your GOOGLEAPPLICATIONCREDENTIALS environment variable to the path of your authentication json.","source":"@site/docs/registry/registry-using-google-storage.md","sourceDirName":"registry","slug":"/registry/registry-using-google-storage","permalink":"/docs/registry/registry-using-google-storage","draft":false,"unlisted":false,"editUrl":"https://github.com/opencomponents/opencomponents.github.io/tree/master/website/docs/registry/registry-using-google-storage.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Registry configuration","permalink":"/docs/registry/registry-configuration"},"next":{"title":"F.A.Q.","permalink":"/docs/reference/faq"}}');var s=o(4848),r=o(8453);const i={sidebar_position:2},a="Registry using Google Storage",c={},l=[{value:"Advanced Configuration Options",id:"advanced-configuration-options",level:2},{value:"Complete Storage Options",id:"complete-storage-options",level:3},{value:"Deployment Scenarios",id:"deployment-scenarios",level:2},{value:"Single Region Deployment",id:"single-region-deployment",level:3},{value:"Multi-Region Deployment",id:"multi-region-deployment",level:3},{value:"Staging and Production Setup",id:"staging-and-production-setup",level:3},{value:"Cost Optimization Strategies",id:"cost-optimization-strategies",level:2},{value:"Storage Class Optimization",id:"storage-class-optimization",level:3},{value:"CDN Integration",id:"cdn-integration",level:3},{value:"Compression and Optimization",id:"compression-and-optimization",level:3},{value:"Security Best Practices",id:"security-best-practices",level:2},{value:"IAM Roles and Permissions",id:"iam-roles-and-permissions",level:3},{value:"Bucket Security Configuration",id:"bucket-security-configuration",level:3},{value:"Environment Variable Security",id:"environment-variable-security",level:3},{value:"Troubleshooting Common Issues",id:"troubleshooting-common-issues",level:2},{value:"Authentication Problems",id:"authentication-problems",level:3},{value:"Storage and Upload Issues",id:"storage-and-upload-issues",level:3},{value:"Performance Issues",id:"performance-issues",level:3},{value:"Network and Connectivity Issues",id:"network-and-connectivity-issues",level:3},{value:"Monitoring and Maintenance",id:"monitoring-and-maintenance",level:2},{value:"Health Checks",id:"health-checks",level:3},{value:"Logging and Monitoring",id:"logging-and-monitoring",level:3},{value:"Next Steps",id:"next-steps",level:2}];function g(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"registry-using-google-storage",children:"Registry using Google Storage"})}),"\n",(0,s.jsxs)(n.p,{children:["To use Google Storage make sure you have an account and credentials. When running on a server don't forget to set your ",(0,s.jsx)(n.code,{children:"GOOGLE_APPLICATION_CREDENTIALS"})," environment variable to the path of your authentication json."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://cloud.google.com/docs/authentication/production",children:"Setting Up Authentication for Server to Server Production Applications"})}),"\n",(0,s.jsx)(n.p,{children:"Install the oc-gs-storage-adapter"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm install oc-gs-storage-adapter --save\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then on the entry point, what you need on an ",(0,s.jsx)(n.code,{children:"index.js"})," file is:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'var oc = require("oc");\nvar gs = require("oc-gs-storage-adapter");\n\nvar configuration = {\n  verbosity: 0,\n  baseUrl: "https://my-components-registry.mydomain.com/",\n  port: 3000,\n  tempDir: "./temp/",\n  refreshInterval: 600,\n  pollingInterval: 5,\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "myproject-12345",\n      bucket: "my-components-bucket",\n      path: "//storage.googleapis.com/my-components-bucket/",\n      componentsDir: "components",\n      maxAge: 3600,\n    },\n  },\n  env: { name: "production" },\n};\n\nconst registry = new oc.Registry(configuration);\n\nregistry.start(function (err, app) {\n  if (err) {\n    console.log("Registry not started: ", err);\n    process.exit(1);\n  }\n  console.log("Registry started successfully on port", configuration.port);\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"advanced-configuration-options",children:"Advanced Configuration Options"}),"\n",(0,s.jsx)(n.h3,{id:"complete-storage-options",children:"Complete Storage Options"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'const storageOptions = {\n  // Required\n  projectId: "myproject-12345",\n  bucket: "my-components-bucket",\n  path: "//storage.googleapis.com/my-components-bucket/",\n\n  // Optional\n  componentsDir: "components", // Directory for components\n  maxAge: 3600, // Cache control max-age (seconds)\n  keyFilename: "./service-account.json", // Path to service account key\n\n  // Advanced options\n  timeout: 30000, // Request timeout (ms)\n  retries: 3, // Number of retries for failed requests\n  autoRetry: true, // Enable automatic retries\n  maxRetryDelay: 64000, // Maximum retry delay (ms)\n\n  // Custom metadata\n  metadata: {\n    cacheControl: "public, max-age=3600",\n    contentType: "application/javascript",\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h2,{id:"deployment-scenarios",children:"Deployment Scenarios"}),"\n",(0,s.jsx)(n.h3,{id:"single-region-deployment",children:"Single Region Deployment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Basic single-region setup\nconst configuration = {\n  baseUrl: "https://components.mycompany.com/",\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "mycompany-components",\n      bucket: "components-prod-us-central1",\n      path: "//storage.googleapis.com/components-prod-us-central1/",\n      componentsDir: "components",\n      maxAge: 86400, // 24 hours\n    },\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"multi-region-deployment",children:"Multi-Region Deployment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Multi-region setup with CDN\nconst configuration = {\n  baseUrl: "https://components-cdn.mycompany.com/",\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "mycompany-components",\n      bucket: "components-prod-multi-region",\n      path: "//storage.googleapis.com/components-prod-multi-region/",\n      componentsDir: "components",\n      maxAge: 604800, // 7 days for CDN caching\n      metadata: {\n        cacheControl: "public, max-age=604800, s-maxage=86400",\n      },\n    },\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"staging-and-production-setup",children:"Staging and Production Setup"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Environment-based configuration\nconst environment = process.env.NODE_ENV || "development";\n\nconst configurations = {\n  development: {\n    bucket: "components-dev",\n    maxAge: 300, // 5 minutes\n    verbosity: 2,\n  },\n  staging: {\n    bucket: "components-staging",\n    maxAge: 3600, // 1 hour\n    verbosity: 1,\n  },\n  production: {\n    bucket: "components-prod",\n    maxAge: 86400, // 24 hours\n    verbosity: 0,\n  },\n};\n\nconst config = configurations[environment];\n\nconst configuration = {\n  baseUrl: `https://components-${environment}.mycompany.com/`,\n  verbosity: config.verbosity,\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "mycompany-components",\n      bucket: config.bucket,\n      path: `//storage.googleapis.com/${config.bucket}/`,\n      maxAge: config.maxAge,\n    },\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h2,{id:"cost-optimization-strategies",children:"Cost Optimization Strategies"}),"\n",(0,s.jsx)(n.h3,{id:"storage-class-optimization",children:"Storage Class Optimization"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Configure lifecycle policies for cost optimization\nconst { Storage } = require("@google-cloud/storage");\n\nconst setupLifecyclePolicies = async (bucketName) => {\n  const storage = new Storage();\n  const bucket = storage.bucket(bucketName);\n\n  await bucket.setMetadata({\n    lifecycle: {\n      rule: [\n        {\n          condition: {\n            age: 30, // 30 days\n            matchesStorageClass: ["STANDARD"],\n          },\n          action: {\n            type: "SetStorageClass",\n            storageClass: "NEARLINE",\n          },\n        },\n        {\n          condition: {\n            age: 90, // 90 days\n            matchesStorageClass: ["NEARLINE"],\n          },\n          action: {\n            type: "SetStorageClass",\n            storageClass: "COLDLINE",\n          },\n        },\n        {\n          condition: {\n            age: 365, // 1 year\n            matchesStorageClass: ["COLDLINE"],\n          },\n          action: {\n            type: "SetStorageClass",\n            storageClass: "ARCHIVE",\n          },\n        },\n      ],\n    },\n  });\n\n  console.log(`Lifecycle policies set for bucket ${bucketName}`);\n};\n\n// Apply lifecycle policies\nsetupLifecyclePolicies("my-components-bucket");\n'})}),"\n",(0,s.jsx)(n.h3,{id:"cdn-integration",children:"CDN Integration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Configure Cloud CDN for better performance and cost\nconst configuration = {\n  baseUrl: "https://components-cdn.mycompany.com/",\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "mycompany-components",\n      bucket: "components-prod",\n      path: "//storage.googleapis.com/components-prod/",\n      maxAge: 2592000, // 30 days\n      metadata: {\n        cacheControl: "public, max-age=2592000, s-maxage=86400",\n      },\n    },\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"compression-and-optimization",children:"Compression and Optimization"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Enable compression for better performance\nconst configuration = {\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: "mycompany-components",\n      bucket: "components-prod",\n      path: "//storage.googleapis.com/components-prod/",\n      metadata: {\n        contentEncoding: "gzip",\n        cacheControl: "public, max-age=86400",\n      },\n    },\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h2,{id:"security-best-practices",children:"Security Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"iam-roles-and-permissions",children:"IAM Roles and Permissions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Create custom role with minimal permissions\ngcloud iam roles create ocRegistryRole \\\n  --project=myproject-12345 \\\n  --title="OC Registry Role" \\\n  --description="Minimal permissions for OC registry" \\\n  --permissions="storage.objects.create,storage.objects.delete,storage.objects.get,storage.objects.list,storage.objects.update"\n\n# Assign role to service account\ngcloud projects add-iam-policy-binding myproject-12345 \\\n  --member="serviceAccount:oc-registry-sa@myproject-12345.iam.gserviceaccount.com" \\\n  --role="projects/myproject-12345/roles/ocRegistryRole"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"bucket-security-configuration",children:"Bucket Security Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Secure bucket configuration\nconst { Storage } = require("@google-cloud/storage");\n\nconst setupBucketSecurity = async (bucketName) => {\n  const storage = new Storage();\n  const bucket = storage.bucket(bucketName);\n\n  // Set uniform bucket-level access\n  await bucket.setMetadata({\n    iamConfiguration: {\n      uniformBucketLevelAccess: {\n        enabled: true,\n      },\n    },\n  });\n\n  // Enable versioning for component history\n  await bucket.setMetadata({\n    versioning: {\n      enabled: true,\n    },\n  });\n\n  // Set CORS policy for web access\n  await bucket.setCorsConfiguration([\n    {\n      origin: ["https://mycompany.com", "https://*.mycompany.com"],\n      method: ["GET", "HEAD"],\n      responseHeader: ["Content-Type", "Access-Control-Allow-Origin"],\n      maxAgeSeconds: 3600,\n    },\n  ]);\n\n  console.log(`Security configuration applied to bucket ${bucketName}`);\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"environment-variable-security",children:"Environment Variable Security"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// Secure environment configuration\nconst configuration = {\n  storage: {\n    adapter: gs,\n    options: {\n      projectId: process.env.GOOGLE_CLOUD_PROJECT_ID,\n      bucket: process.env.GOOGLE_STORAGE_BUCKET,\n      path: process.env.GOOGLE_STORAGE_PATH,\n      keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,\n      // Never hardcode credentials in source code\n    },\n  },\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting-common-issues",children:"Troubleshooting Common Issues"}),"\n",(0,s.jsx)(n.h3,{id:"authentication-problems",children:"Authentication Problems"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Error: Could not load the default credentials"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Solution 1: Set environment variable\nexport GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"\n\n# Solution 2: Use gcloud auth for development\ngcloud auth application-default login\n\n# Solution 3: Verify service account permissions\ngcloud projects get-iam-policy PROJECT_ID \\\n  --flatten="bindings[].members" \\\n  --format="table(bindings.role)" \\\n  --filter="bindings.members:serviceAccount:YOUR_SERVICE_ACCOUNT"\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Access denied" errors']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Check bucket permissions\ngsutil iam get gs://your-bucket-name\n\n# Add necessary permissions\ngsutil iam ch serviceAccount:your-sa@project.iam.gserviceaccount.com:objectAdmin gs://your-bucket-name\n"})}),"\n",(0,s.jsx)(n.h3,{id:"storage-and-upload-issues",children:"Storage and Upload Issues"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Component upload fails"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// Debug storage adapter issues\nconst configuration = {\n  verbosity: 2, // Enable detailed logging\n  storage: {\n    adapter: gs,\n    options: {\n      // ... your options\n      timeout: 60000, // Increase timeout for large components\n      retries: 5, // Increase retry attempts\n    },\n  },\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Bucket not found" errors']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Verify bucket exists and is accessible\ngsutil ls gs://your-bucket-name\n\n# Create bucket if needed\ngsutil mb -p your-project-id -c STANDARD -l us-central1 gs://your-bucket-name\n"})}),"\n",(0,s.jsx)(n.h3,{id:"performance-issues",children:"Performance Issues"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Slow component loading"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Optimize for performance\nconst configuration = {\n  storage: {\n    adapter: gs,\n    options: {\n      // Use regional bucket for better performance\n      bucket: "components-us-central1",\n      // Increase cache time\n      maxAge: 86400,\n      // Enable compression\n      metadata: {\n        contentEncoding: "gzip",\n        cacheControl: "public, max-age=86400",\n      },\n    },\n  },\n};\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "High storage costs"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Analyze storage usage\ngsutil du -sh gs://your-bucket-name\n\n# Check storage class distribution\ngsutil ls -L -b gs://your-bucket-name\n\n# Apply lifecycle policies to reduce costs\ngsutil lifecycle set lifecycle.json gs://your-bucket-name\n"})}),"\n",(0,s.jsx)(n.h3,{id:"network-and-connectivity-issues",children:"Network and Connectivity Issues"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "Timeout errors during component requests"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// Increase timeouts and add retry logic\nconst configuration = {\n  storage: {\n    adapter: gs,\n    options: {\n      timeout: 30000,\n      retries: 3,\n      autoRetry: true,\n      maxRetryDelay: 64000,\n    },\n  },\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),': "CORS errors in browser"']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Set CORS configuration\ngsutil cors set cors.json gs://your-bucket-name\n\n# Example cors.json:\n# [\n#   {\n#     "origin": ["https://yoursite.com"],\n#     "method": ["GET", "HEAD"],\n#     "responseHeader": ["Content-Type"],\n#     "maxAgeSeconds": 3600\n#   }\n# ]\n'})}),"\n",(0,s.jsx)(n.h2,{id:"monitoring-and-maintenance",children:"Monitoring and Maintenance"}),"\n",(0,s.jsx)(n.h3,{id:"health-checks",children:"Health Checks"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Add health check endpoint\nconst configuration = {\n  // ... other options\n  customRoutes: [\n    {\n      route: "/health",\n      method: "get",\n      handler: (req, res) => {\n        // Check storage connectivity\n        const storage = new (require("@google-cloud/storage").Storage)();\n        storage\n          .bucket(process.env.GOOGLE_STORAGE_BUCKET)\n          .exists()\n          .then(([exists]) => {\n            if (exists) {\n              res.json({ status: "healthy", storage: "connected" });\n            } else {\n              res\n                .status(500)\n                .json({ status: "unhealthy", storage: "bucket not found" });\n            }\n          })\n          .catch((error) => {\n            res.status(500).json({ status: "unhealthy", error: error.message });\n          });\n      },\n    },\n  ],\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"logging-and-monitoring",children:"Logging and Monitoring"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// Enhanced logging configuration\nconst configuration = {\n  verbosity: process.env.NODE_ENV === "production" ? 0 : 1,\n  storage: {\n    adapter: gs,\n    options: {\n      // ... storage options\n    },\n  },\n  // Custom logging\n  customLogger: {\n    info: (message) =>\n      console.log(`[INFO] ${new Date().toISOString()} ${message}`),\n    warn: (message) =>\n      console.warn(`[WARN] ${new Date().toISOString()} ${message}`),\n    error: (message) =>\n      console.error(`[ERROR] ${new Date().toISOString()} ${message}`),\n  },\n};\n'})}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"registry-configuration",children:"Registry Configuration"})})," - Complete registry setup options"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"../components/publishing-to-a-registry",children:"Publishing Components"})})," - Deploy components to your registry"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"../consumers/client-side-rendering",children:"Client-side Integration"})})," - Consume components in applications"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"../concepts/architecture-overview",children:"Architecture Overview"})})," - Understand the complete system"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(g,{...e})}):g(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>a});var t=o(6540);const s={},r=t.createContext(s);function i(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);